<script type="text/javascript">
    RED.nodes.registerType('hal2ThingType', {
        category: 'config',
        defaults: {
            name:  {
                value: "Thing type",
                required: true,     
                validate:function(v) {
                    //Check for name collisions
                    const thingsList = RED.nodes.filterNodes({type: "hal2ThingType"});
                    if(thingsList.length===0){ return true; }
                    for (var d in thingsList) {
                        if (v == thingsList[d].name && thingsList[d].id !== this.id) { return false; }
                    }
                    return true;
                }
            },
            contextStore: {},
            nodestatus: {},
            items: { value: [], required: true },
            attributes: { value: [], required: false },
            ingress: {},
            egress: {},
            thingStatus: {},
            thingCommand: {},
            hbCheck: { value:false },
            hbType: { value:"lwt" },
            hbTTL: {},
            hbLWT: {},
            hbFilterVal: {},
            hbFilterType: {}
        },
        label: function () {
            return this.name || "Thing type";
        },
        oneditprepare: function () {
            var node = this;
            node.editor = {};
            var contextStores = RED.settings.context.stores;
            
            //Types
            var stateType = {
                value: "state",
                label: "state.",
                hasValue: true
            };
            var percentType = {
                value: "percent",
                label: "percent",
                icon: "fa fa-percent",
                validate: /^\b([0-9]|[1-9][0-9]|100)\b$/,
                hasValue: true
            }
            var functionType = {
                value: "function",
                label: "func",
                icon: "function.svg",
                hasValue: true
            }
            var MQTTType = {
                value: "mqtt",
                label: "MQTT Topic",
                icon: "fa fa-tasks",
                validate: /^(#$|(\+|[^+#]*)(\/(\+|[^+#]*))*(\/(\+|#|[^+#]*))?$)/,
                hasValue: true
            }
            var StrStartType = {
            value: "StrStart",
            label: "starts with",
            hasValue: true
            }            
            var StrEndType = {
            value: "StrEnd",
            label: "ends with",
            hasValue: true
            }
            var StrContainsType = {
            value: "StrContain",
            label: "contains",
            hasValue: true
            }

            function createId () {
                return (1+Math.random()*4294967295).toString(16);
            }

            var defaultIngressFunctions = {
                0 : {
                    name: "Pass-through",
                    id: createId(),
                    fn: "// msg & attribute objects are passed to function\n\nreturn msg.payload;"
                },
                1 : {
                    name: "Convert to Number",
                    id: createId(),
                    fn: "// msg & attribute objects are passed to function\n\nmsg.payload = Number(msg.payload);\nreturn msg.payload;"
                },                
                2 : {
                    name: "Convert to Boolean",
                    id: createId(),
                    fn: "// msg & attribute objects are passed to function\n\nmsg.payload = (msg.payload === 'true');\nreturn msg.payload;"
                }, 
            }
            var defaultEgressFunctions = {
                0 : {
                    name: "Pass-through",
                    id: createId(),
                    fn: "// msg & attribute objects are passed to function\n\nreturn msg;"
                }
            }
        var lastTab = "";

        // Get thingTypes
        const completeThingsList = RED.nodes.filterNodes({type: "hal2Thing"});
        var thingsList = [];
        for (let t in completeThingsList) {
            let thingType = RED.nodes.node(completeThingsList[t].thingType);
            if ((typeof thingType !== 'undefined') && (thingType.thingStatus)) {
                thingsList.push(completeThingsList[t]);
            }
        }
        if(thingsList.length>0){
            //get all Thingtypes and sort them alphabetically
            var thingTypeId = [];
            for (let i in thingsList) {
                if (thingTypeId.indexOf(thingsList[i].thingType) == -1) {
                    thingTypeId.push(thingsList[i].thingType);
                }
            }
            var thingTypeList = [];
            for (let i in thingTypeId) {
                var thingType = RED.nodes.node(thingTypeId[i]);
                if (thingType.thingStatus) {
                    thingTypeList.push(thingType);
                }
            }
            thingTypeList.sort(function(a, b) {
                var textA = a.name.toUpperCase();
                var textB = b.name.toUpperCase();
                return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
            });
        }         
        
        function updateMainTab(id) {
            var items = [];
            $("#node-config-"+id+"-list-items")
                .editableList('items')
                .each(function() {
                    let item = $(this);
                    let params = {
                        name:item.find(".node-config-"+id+"-name-property").val(),
                        id:item.find(".node-config-"+id+"-id-property").val()
                    }
                    items.push(params);
                })
                
            $("#node-config-thingtype-list-items")
                .editableList('items')
                .each(function() {
                    var property = this.find(".node-config-thingtype-"+id+"-property");
                    let saveValue = property.val();
                    property.children().remove();
                    for (let i in items) {
                        property.append($("<option></option>").val(items[i].id).text(items[i].name));
                    }
                    property.val(saveValue);                                 
                });                     
        }

        // Create tabs
            var tabs = RED.tabs.create({
                id: "tabs",
                onchange: function(tab) {
                    $("#tabs-content").children().hide();
                    $("#" + tab.id).show();

                    switch (lastTab) {
                        case 'tab-ingress':
                            updateMainTab('ingress');
                            break;
                        case 'tab-egress':
                            updateMainTab('egress')
                            break;
                    }
                    lastTab = tab.id;
                }
            });
            tabs.addTab({
                id: "tab-main",
                iconClass: "fa fa-cog",
                label: "Main"
            });
            tabs.addTab({
                id: "tab-ingress",
                iconClass: "fa fa-sign-in",
                label: "Ingress",
            });
            tabs.addTab({
                id: "tab-egress",
                iconClass: "fa fa-sign-out",
                label: "Egress"
            });
            tabs.activateTab("tab-main");

        // Main
            //Context stores from setup
            for (let c in contextStores) {
                $("<option value='" + contextStores[c] + "'> " + contextStores[c] + "</option>").appendTo("#node-config-input-contextStore");
            }
            if (this.contextStore) {
                $("#node-config-input-contextStore").val(this.contextStore);
                $("#node-config-input-contextStore").trigger("change");
            }

            // Heartbeat
            $("#node-config-input-hbCheck").change( function () {
                if ($("#node-config-input-hbCheck").is(":checked")) {
                    $("#check-heartbeat").show();
                } else {
                    $("#check-heartbeat").hide();
                }
            });
            $("#node-config-input-hbType").change( function () {
                if ($("#node-config-input-hbType").val() == "ttl") {
                    $("#heartbeat-ttl").show();
                    $("#heartbeat-lwt").hide();
                } else {
                    $("#heartbeat-ttl").hide();
                    $("#heartbeat-lwt").show();                
                }
            });
            $('#node-config-input-hbFilterVal').typedInput({
                default: 'StrEnd',
                typeField: $("#node-config-input-hbFilterType"),
                types:['str',StrStartType,StrEndType,StrContainsType,'re',MQTTType]
            });              

            $("#node-config-thingtype-list-items").editableList({
                addItem: function(container,i,opt) {
                    var item = opt;
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });

                    //Add rows
                    var rowName = $('<div/>').appendTo(container);
                    var rowDetails = $('<div/>',{style:"margin-top:8px;"})
                        .appendTo(container)
                        .hide()
                    var rowTopicFilter = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);
                    var rowItemType = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);  
                    var rowIngress = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);
                    var rowEgress = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);
                    var rowTopicSuffix = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);
                    var rowNotes = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);

                    // Show a clickable expand icon
                    var expandButton = $('<span/>', {style: "margin-left:5px; margin-right:10px"})
                        .html('<i class="fa fa-angle-right"></i>')
                        .appendTo(rowName);
                    expandButton.click(function(e) {
                        e.preventDefault();
                        
                        // Switch the icon between expand and compress
                        if (this.firstElementChild.className === "fa fa-angle-right") {
                            this.firstElementChild.className = "fa fa-angle-down";
                        }
                        else {
                            this.firstElementChild.className = "fa fa-angle-right";
                        }
                    
                        // Only show the relevant widget type properties
                        rowDetails.change();
                    });

                    rowDetails.change(function () {
                        if (expandButton.children()[0].className === "fa fa-angle-down") {
                            rowDetails.show();
                        } else {
                            rowDetails.hide();
                        }
                    });

                    //Add labels
                    var labelName = $('<div/>',{style:"display:inline-block;text-align:left; width: 90px; padding-right:10px; box-sizing:border-box;",class:"fa fa-tag"})
                        .appendTo(rowName)
                        .append(' Item name')
                    var labelTopicFilter = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px; padding-right:10px; box-sizing:border-box;",class:"fa fa-filter"})
                        .appendTo(rowTopicFilter)
                        .append(' Topic filter')
                    var labelItemType = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px;  padding-right:10px; box-sizing:border-box;",class:"fa fa-arrows-h"})
                        .appendTo(rowItemType)
                        .append(' Type')                          
                    var labelIngress = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px;  padding-right:10px; box-sizing:border-box;",class:"fa fa-sign-in"})
                        .appendTo(rowIngress)
                        .append(" Ingress")
                    var labelEgress = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px;  padding-right:10px; box-sizing:border-box;",class:"fa fa-sign-out"})
                        .appendTo(rowEgress)
                        .append(" Egress")
                    var labelTopicSuffix = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px;  padding-right:10px; box-sizing:border-box;",class:"fa fa-tasks"})
                        .appendTo(rowTopicSuffix)
                        .append(' Cmnd suffix')
                    var labelNotes = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px;  padding-right:10px; box-sizing:border-box;",class:"fa fa-file"})
                        .appendTo(rowNotes)
                        .append(' Notes')
                  
                    //Name property
                    var nameProperty = $('<input/>',{style: "padding-right:10px; width: calc(100% - 125px)",class:"node-config-thingtype-name-property",type:"text"})
                        .appendTo(rowName)
                        .prop('required',true);
                    var idProperty = $('<input/>',{class:"node-config-thingtype-id-property",type:"hidden"})
                        .appendTo(rowName)
                        .val(createId())
                    //MQTT topic filter
                    var topicFilterProperty = $('<input/>',{style: "width: calc(100% - 125px)",class:"node-config-thingtype-topicfilter-property",type:"text"})
                    .appendTo(rowTopicFilter)
                    .typedInput({
                        default:'StrEnd',
                        types:['str',StrStartType,StrEndType,StrContainsType,'re',MQTTType]
                    });
                    // Item type
                    var itemTypeProperty = $('<select/>',{class:"node-config-thingtype-itemtype-property",style:"width:calc(100% - 125px)"})
                        .appendTo(rowItemType)
                        .append($("<option></option>").val('both').text('Command & Status'))
                        .append($("<option></option>").val('status').text('Status only'))
                        .append($("<option></option>").val('command').text('Command only'))                     
                    //MQTT topic suffix
                    var topicSuffixProperty = $('<input/>',{style: "width: calc(100% - 125px)",class:"node-config-thingtype-topicsuffix-property",type:"text"})
                    .appendTo(rowTopicSuffix)
                    //Ingress
                    var ingressProperty = $('<select/>',{class:"node-config-thingtype-ingress-property",style:"width:calc(100% - 125px)"})
                        .appendTo(rowIngress);

                    $("#node-config-ingress-list-items")
                        .editableList('items')
                        .each(function() {
                            var item = $(this);
                            let name = item.find(".node-config-ingress-name-property").val();
                            let id = item.find(".node-config-ingress-id-property").val();
                            ingressProperty.append($("<option></option>").val(id).text(name));
                        })
                    //Egress
                    var egressProperty = $('<select/>',{class:"node-config-thingtype-egress-property",style:"width:calc(100% - 125px)"})
                        .appendTo(rowEgress);

                    $("#node-config-egress-list-items")
                        .editableList('items')
                        .each(function() {
                            var item = $(this);
                            let name = item.find(".node-config-egress-name-property").val();
                            let id = item.find(".node-config-egress-id-property").val();
                            egressProperty.append($("<option></option>").val(id).text(name));
                        })                    
                    
                    // Notes
                    var notesProperty = $('<textarea/>',{class:"node-config-thingtype-notes-property",style:"width:calc(100% - 125px)"})
                        .appendTo(rowNotes)

                    // Show/hide ingress/egress/command
                    itemTypeProperty.change( function() {
                        let val = itemTypeProperty.val();
                        switch(val) {
                            case 'both':
                                rowTopicSuffix.show();
                                rowEgress.show();
                                rowIngress.show();
                                break;
                            case 'status':
                                rowTopicSuffix.hide();
                                rowEgress.hide();
                                rowIngress.show();
                                break;
                            case 'command':
                                rowTopicSuffix.show();
                                rowEgress.show();
                                rowIngress.hide();
                                break;
                        }
                    });

                    //Add values
                    if (Object.keys(item).length != 0) {
                        nameProperty.val(item.name);
                        idProperty.val(item.id);
                        topicFilterProperty.typedInput('type',item.topicFilterType);
                        topicFilterProperty.typedInput('value',item.topicFilterValue);
                        topicSuffixProperty.val(item.topicSuffix);
                        itemTypeProperty.val(item.type);
                        ingressProperty.val(item.ingress);
                        egressProperty.val(item.egress);
                        notesProperty.val(item.notes);
                    }
                    itemTypeProperty.trigger('change');
                },
                removable: true,
                sortable: true,
                addButton: "Item"
            });

            $("#node-config-thingtype-list-attributes").editableList({
                addItem: function(container,i,opt) {
                    var item = opt;
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });

                    //Add rows
                    var rowName = $('<div/>').appendTo(container);
                    var rowDetails = $('<div/>',{style:"margin-top:8px;"})
                        .appendTo(container)
                        .hide()
                    var rowDescription = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);  
                    var rowRequired = $('<div/>',{style:"margin-top:8px;"}).appendTo(rowDetails);

                    // Show a clickable expand icon
                    var expandButton = $('<span/>', {style: "margin-left:5px; margin-right:10px"})
                        .html('<i class="fa fa-angle-right"></i>')
                        .appendTo(rowName);
                    expandButton.click(function(e) {
                        e.preventDefault();
                        
                        // Switch the icon between expand and compress
                        if (this.firstElementChild.className === "fa fa-angle-right") {
                            this.firstElementChild.className = "fa fa-angle-down";
                        }
                        else {
                            this.firstElementChild.className = "fa fa-angle-right";
                        }
                    
                        // Only show the relevant widget type properties
                        rowDetails.change();
                    });

                    rowDetails.change(function () {
                        if (expandButton.children()[0].className === "fa fa-angle-down") {
                            rowDetails.show();
                        } else {
                            rowDetails.hide();
                        }
                    });

                    //Add labels
                    var labelName = $('<div/>',{style:"display:inline-block;text-align:left; width: 90px; padding-right:10px; box-sizing:border-box;",class:"fa fa-tag"})
                        .appendTo(rowName)
                        .append(' Attribute')
                    var labelDescription = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px;  padding-right:10px; box-sizing:border-box;",class:"fa fa-file"})
                        .appendTo(rowDescription)
                        .append(' Notes')                          
                        var labelrequired = $('<div/>',{style:"display:inline-block;text-align:left; width: 115px; padding-left: 25px; padding-right:10px; box-sizing:border-box;",class:"fa fa-check"})
                        .appendTo(rowRequired)
                        .append(' Required')
                  
                    var nameProperty = $('<input/>',{style: "padding-right:10px; width: calc(100% - 125px)",class:"node-config-thingtype-attribute-name-property",type:"text"})
                        .appendTo(rowName)
                        .prop('required',true);
                    var idProperty = $('<input/>',{class:"node-config-thingtype-attribute-id-property",type:"hidden"})
                        .appendTo(rowName)
                        .val(createId())
                    var notesProperty = $('<textarea/>',{class:"node-config-thingtype-attribute-notes-property",style:"width:calc(100% - 125px)"})
                        .appendTo(rowDescription)
                        var requiredProperty = $('<input/>',{style: "width: calc(100% - 125px)",class:"node-config-thingtype-attribute-required-property",type:"checkbox"})
                        .appendTo(rowRequired)

                    //Add values
                    if (Object.keys(item).length != 0) {
                        nameProperty.val(item.name);
                        idProperty.val(item.id);
                        requiredProperty.prop('checked',item.required);
                        notesProperty.val(item.topicSuffix);
                    }
                },
                removable: true,
                sortable: true,
                addButton: "Attribute"
            });

        // Ingress
            $("#node-config-ingress-list-items").editableList({
                addItem: function(container,i,opt) {
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });    

                    //Add rows
                    var rowName = $('<div/>').appendTo(container);
                    var rowEditor = $('<div/>',{style:"margin-top:8px;"})
                        .appendTo(container)
                        .hide()

                    // Show a clickable expand icon
                    var expandButton = $('<span/>', {style: "margin-left:5px; margin-right:10px;"})
                        .html('<i class="fa fa-angle-right"></i>')
                        .appendTo(rowName);
                    expandButton.click(function(e) {
                        e.preventDefault();
                        
                        // Switch the icon between expand and compress
                        if (this.firstElementChild.className === "fa fa-angle-right") {
                            this.firstElementChild.className = "fa fa-angle-down";
                        }
                        else {
                            this.firstElementChild.className = "fa fa-angle-right";
                        }
                    
                        // Only show the relevant widget type properties
                        rowEditor.change();
                    });

                    rowEditor.change(function () {
                        if (expandButton.children()[0].className === "fa fa-angle-down") {
                            rowEditor.show();
                        } else {
                            rowEditor.hide();
                        }
                    });

                    //Add labels
                    var labelName = $('<div/>',{style:"display:inline-block;text-align:left; width:90px; padding-right:10px; box-sizing:border-box;",class:"fa fa-tag"})
                        .appendTo(rowName)
                        .append(' Name')
                    var labelFnStart = $('<div/>',{style:"display:inline-block;text-align:left; width:90px; padding-right:10px; box-sizing:border-box;",class:"fa fa-cog"})
                        .appendTo(rowEditor)
                        .append(" Function")
                    var labelEditor = $('<div/>',{style:"display:inline-block;text-align:left;float:right; padding-right:10px; box-sizing:border-box;"})
                        .appendTo(rowEditor)

                    //Name property
                    var nameProperty = $('<input/>',{style: "padding-right:10px; width: calc(100% - 115px)",class:"node-config-ingress-name-property",type:"text"})
                        .appendTo(rowName)
                    var idProperty = $('<input/>',{class:"node-config-ingress-id-property",type:"hidden"})
                        .appendTo(rowName)
                        .val(createId())

                    //Add name+id values
                    if (Object.keys(opt).length != 0) {
                        nameProperty.val(opt.name);
                        idProperty.val(opt.id);
                    } else {
                        nameProperty.val("Ingress function");
                    }                        
                    var editorId = "ingress-"+idProperty.val();
                    editorId = editorId.split('.').join("");
                    var editorProperty = $('<div/>',{id:editorId,style:"height: 250px; min-height:150px;width: calc(100% - 115px);float:right;",class:"red-ui-editor-text-container"})
                        .appendTo(rowEditor)

                    node.editor[editorId] = RED.editor.createEditor({
                        id: editorId,
                        mode: "ace/mode/nrjavascript",
                        value: "", 
                        globals: {
                                msg:true,
                                context:true,
                                RED: true,
                                util: true,
                                flow: true,
                                global: true,
                                console: true,
                                Buffer: true,
                                setTimeout: true,
                                clearTimeout: true,
                                setInterval: true,
                                clearInterval: true
                            }
                    });
                    //Add editor value
                    if (Object.keys(opt).length != 0) {
                        node.editor[editorId].setValue(opt.fn);
                    } else {
                        nameProperty.val("Ingress function");
                        node.editor[editorId].setValue("// msg object is passed to function\n\nreturn msg.payload;");
                    }
                },
                removable: true,
                sortable: true,
                addButton: "Add ingress function"
            });

            //Copy functions from other types
            $('#tab-ingress-copy-show').on('click', function() {
                if ($('#tab-ingress-copy').is(':visible')) {
                    $('#tab-ingress-copy').hide();
                } else {
                    $('#tab-ingress-copy').show();
                }
            });

            $('#tab-ingress-copy-button').on('click', function () {
                var thingType = RED.nodes.node($('#tab-ingress-copy-thing').val());
                var selectedFn = $('#tab-ingress-copy-ingress').val();
                for (n in thingType.ingress) {
                    if (thingType.ingress[n].id == selectedFn) {
                        $("#node-config-ingress-list-items").editableList('addItem',thingType.ingress[n]);
                        $("#node-config-ingress-list-items").trigger('change');
                        break;
                    }
                }
            });

            $('#tab-ingress-copy-thing').on('change', function() {
                $("#tab-ingress-copy-ingress").children().remove();
                var thingType = RED.nodes.node($('#tab-ingress-copy-thing').val());
                if (typeof thingType !== 'undefined') {
                    for (let n in thingType.ingress) {
                        $("<option value='" + thingType.ingress[n].id + "'>" + thingType.ingress[n].name + "</option>").appendTo("#tab-ingress-copy-ingress");
                    }
                }
            });

            for (let d in thingTypeList) {
                if (thingTypeList[d].id != node.id) {
                    $("<option value='" + thingTypeList[d].id + "'>" + thingTypeList[d].name + "</option>").appendTo("#tab-ingress-copy-thing");
                }
            }
            $('#tab-ingress-copy-thing').trigger('change');

        // Egress
            $("#node-config-egress-list-items").editableList({
                addItem: function(container,i,opt) {
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });

                    //Add rows
                    var rowName = $('<div/>').appendTo(container);
                    var rowEditor = $('<div/>',{style:"margin-top:8px;"}).appendTo(container)
                        .hide()

                    // Show a clickable expand icon
                    var expandButton = $('<span/>', {style: "margin-left:5px; margin-right:10px;"})
                        .html('<i class="fa fa-angle-right"></i>')
                        .appendTo(rowName);
                    expandButton.click(function(e) {
                        e.preventDefault();
                        
                        // Switch the icon between expand and compress
                        if (this.firstElementChild.className === "fa fa-angle-right") {
                            this.firstElementChild.className = "fa fa-angle-down";
                        }
                        else {
                            this.firstElementChild.className = "fa fa-angle-right";
                        }
                    
                        // Only show the relevant widget type properties
                        rowEditor.change();
                    });

                    rowEditor.change(function () {
                        if (expandButton.children()[0].className === "fa fa-angle-down") {
                            rowEditor.show();
                        } else {
                            rowEditor.hide();
                        }
                    });

                    //Add labels
                    var labelName = $('<div/>',{style:"display:inline-block;text-align:left; width:90px; padding-right:10px; box-sizing:border-box;",class:"fa fa-tag"})
                        .appendTo(rowName)
                        .append(' Name')
                    var labelFnStart = $('<div/>',{style:"display:inline-block;text-align:left; width:90px; padding-right:10px; box-sizing:border-box;",class:"fa fa-cog"})
                        .appendTo(rowEditor)
                        .append(" Function")
                    var labelEditor = $('<div/>',{style:"display:inline-block;text-align:left;float:right; padding-right:10px; box-sizing:border-box;"})
                        .appendTo(rowEditor)

                    //Name property
                    var nameProperty = $('<input/>',{style: "padding-right:10px; width: calc(100% - 115px)",class:"node-config-egress-name-property",type:"text"})
                        .appendTo(rowName)
                    var idProperty = $('<input/>',{class:"node-config-egress-id-property",type:"hidden"})
                        .appendTo(rowName)
                        .val(createId())

                    //Add name+id values
                    if (Object.keys(opt).length != 0) {
                        nameProperty.val(opt.name);
                        idProperty.val(opt.id);
                    } else {
                        nameProperty.val("Egress function");
                    }
                    var editorId = "egress-"+idProperty.val();
                    editorId = editorId.split('.').join("");
                    var editorProperty = $('<div/>',{id:editorId,style:"height: 250px; min-height:150px;width: calc(100% - 115px);float:right;",class:"red-ui-editor-text-container"})
                        .appendTo(rowEditor)

                    node.editor[editorId]= RED.editor.createEditor({
                        id: editorId,
                        mode: "ace/mode/nrjavascript",
                        value: "",
                        globals: {
                                msg:true,
                                context:true,
                                RED: true,
                                util: true,
                                flow: true,
                                global: true,
                                console: true,
                                Buffer: true,
                                setTimeout: true,
                                clearTimeout: true,
                                setInterval: true,
                                clearInterval: true
                            }
                    });

                    //Add editor values
                    if (Object.keys(opt).length != 0) {
                        node.editor[editorId].setValue(opt.fn);
                    } else {
                        node.editor[editorId].setValue("// msg object is passed to function\n\nreturn msg;");
                    }
                },
                removable: true,
                sortable: true,
                addButton: "Add egress function"
            });

            //Copy functions from other types
            $('#tab-egress-copy-show').on('click', function() {
                if ($('#tab-egress-copy').is(':visible')) {
                    $('#tab-egress-copy').hide();
                } else {
                    $('#tab-egress-copy').show();
                }
            });

            $('#tab-egress-copy-button').on('click', function () {
                var thingType = RED.nodes.node($('#tab-egress-copy-thing').val());
                var selectedFn = $('#tab-egress-copy-egress').val();
                for (n in thingType.egress) {
                    if (thingType.egress[n].id == selectedFn) {
                        $("#node-config-egress-list-items").editableList('addItem',thingType.egress[n]);
                        $("#node-config-egress-list-items").trigger('change');
                        break;
                    }
                }
            });

            $('#tab-egress-copy-thing').on('change', function() {
                $("#tab-egress-copy-egress").children().remove();
                var thingType = RED.nodes.node($('#tab-egress-copy-thing').val());
                if (typeof thingType !== 'undefined') {
                    for (let n in thingType.egress) {
                        $("<option value='" + thingType.egress[n].id + "'>" + thingType.egress[n].name + "</option>").appendTo("#tab-egress-copy-egress");
                    }
                }
            });

            for (let d in thingTypeList) {
                if (thingTypeList[d].id != node.id) {
                    $("<option value='" + thingTypeList[d].id + "'>" + thingTypeList[d].name + "</option>").appendTo("#tab-egress-copy-thing");
                }
            }
            $('#tab-egress-copy-thing').trigger('change');            

        //Add items
            //Attributes
            if (this.attributes) {
                for (let d in this.attributes) {
                    let attribute = this.attributes[d];
                    $("#node-config-thingtype-list-attributes").editableList('addItem',attribute);
                }
            }
           if (this.ingress) {
                for (let d in this.ingress) {
                    let ingress = this.ingress[d];
                    $("#node-config-ingress-list-items").editableList('addItem',ingress);
                }
            } else {
                for (let d in defaultIngressFunctions) {
                    $("#node-config-ingress-list-items").editableList('addItem',defaultIngressFunctions[d]);
                }
            }

            if (this.egress) {
                for (let d in this.egress) {
                    let egress = this.egress[d];
                    $("#node-config-egress-list-items").editableList('addItem',egress);
                }
            } else {
                for (let d in defaultEgressFunctions) {
                    $("#node-config-egress-list-items").editableList('addItem',defaultEgressFunctions[d]);
                }
            }

            if (this.items) {
                for (let d in this.items) {
                    let item = this.items[d];
                    if (item.id.length > 1) {
                        $("#node-config-thingtype-list-items").editableList('addItem',item);
                    }
                }
            } else {
                $("#node-config-thingtype-list-items").editableList('addItem',null);
            }

            // Add ingress items to heartbeat
            $("#node-config-ingress-list-items")
                .editableList('items')
                .each(function() {
                    var item = $(this);
                    let name = item.find(".node-config-ingress-name-property").val();
                    let id = item.find(".node-config-ingress-id-property").val();
                    $("#node-config-input-hbLWT").append($("<option></option>").val(id).text(name));
                })
            if (this.hbLWT) {
                $("#node-config-input-hbLWT").val(this.hbLWT);
            }
            $("#node-config-input-hbType").trigger('change');
        },
        oneditsave: function () {
            var node = this;
            var i;
            node.attributes = [];
            node.items = [];
            node.ingress = [];
            node.egress = [];
            node.thingStatus = false;
            node.thingCommand = false;

            // Main tab
            $("#node-config-thingtype-list-attributes")
                .editableList('items')
                .each(function() {
                    let item = $(this);
                    let r = {
                        name:item.find(".node-config-thingtype-attribute-name-property").val(),
                        id:item.find(".node-config-thingtype-attribute-id-property").val(),
                        required:item.find(".node-config-thingtype-attribute-required-property").prop('checked'),
                        notes:item.find(".node-config-thingtype-attribute-notes-property").val()
                    }
                    node.attributes.push(r);
                })
            $("#node-config-thingtype-list-items")
                .editableList('items')
                .each(function() {
                    let item = $(this);
                    let r = {
                        name:item.find(".node-config-thingtype-name-property").val(),
                        id:item.find(".node-config-thingtype-id-property").val(),
                        topicFilterType:item.find(".node-config-thingtype-topicfilter-property").typedInput('type'),
                        topicFilterValue:item.find(".node-config-thingtype-topicfilter-property").typedInput('value'),
                        topicSuffix:item.find(".node-config-thingtype-topicsuffix-property").val(),
                        type:item.find(".node-config-thingtype-itemtype-property").val(),
                        ingress:item.find(".node-config-thingtype-ingress-property").val(),
                        egress:item.find(".node-config-thingtype-egress-property").val(),
                        notes:item.find(".node-config-thingtype-notes-property").val()
                    }
                    switch(r.type) {
                        case 'both':
                            node.thingStatus = true;
                            node.thingCommand = true;
                            break;
                        case 'status':
                            node.thingStatus = true;
                            break;
                        case 'command':
                            node.thingCommand = true;
                            break;
                    }
                    node.items.push(r);
                })
            if ($("#node-config-input-hbCheck").is(":checked")) {
                let r = {
                        name: "Alive",
                        id: "1",
                        topicFilterType:$("#node-config-input-hbFilterType").val(),
                        topicFilterValue:$("#node-config-input-hbFilterVal").val(),
                        topicSuffix: "",
                        readOnly: true,
                        ingress:$("#node-config-input-hbLWT").val(),
                        egress: ""
                }
                node.items.push(r); 
            }

            // Ingress tab
            $("#node-config-ingress-list-items")
                .editableList('items')
                .each(function() {
                    let item = $(this);
                    let name = item.find(".node-config-ingress-name-property").val();
                    let id = item.find(".node-config-ingress-id-property").val();
                    let editorId = "ingress-"+id;
                    editorId = editorId.split('.').join("");
                    let fn = node.editor[editorId].getValue();
                    let r = {
                        name:name,
                        id:id,
                        fn:fn
                    }
                    node.ingress.push(r);
                })

            // Egress tab
            $("#node-config-egress-list-items")
                .editableList('items')
                .each(function() {
                    let item = $(this);
                    let name = item.find(".node-config-egress-name-property").val();
                    let id = item.find(".node-config-egress-id-property").val();
                    let editorId = "egress-"+id;
                    editorId = editorId.split('.').join("");
                    let fn = node.editor[editorId].getValue();
                    let r = {
                        name:name,
                        id:id,
                        fn:fn
                    }
                    node.egress.push(r);
                })

                // Remove editors
            for (n in node.editor) {
                node.editor[n].destroy();
                delete node.editor[n];
            }
        },
        oneditcancel: function() {
            // Remove editors
            for (n in node.editor) {
                node.editor[n].destroy();
                delete node.editor[n];
            }
        }
    });
</script>

<script type="text/html" data-template-name="hal2ThingType">
    <!-- Tabs -->
    <div class="form-row tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="tabs"></ul>
    </div>
    <div id="tabs-content" style="min-height: calc(100% - 95px);">
        <!-- Main tab -->
        <div id="tab-main" style="display:none">
            <div class="form-row">
                <label for="node-config-input-name" style="width: 125px; padding-left: 10px;"><i class="fa fa-tag"></i> Name</label>
                <input type="text" id="node-config-input-name" placeholder="Name" style="width: calc(100% - 185px)">
            </div>
            <div class="form-row">
                <label for="node-config-input-contextStore" style="width: 125px; padding-left: 10px;"><i class="fa fa-database"></i> Context store</label>
                <select id="node-config-input-contextStore" style="width: calc(100% - 185px)"></select>
            </div>
            <div class="form-row">
                <label for="node-config-input-nodestatus" style="width: 125px; padding-left: 10px;"><i class="fa fa-quote-right"></i> Show state</label>
                <input type="text" id="node-config-input-nodestatus" placeholder="Relay0: %relay0%" style="width: calc(100% - 185px)">
            </div>
            <div class="form-row">
                <label for="node-config-input-hbCheck" style="width: 125px; padding-left: 10px;"><i class="fa fa-heartbeat"></i> Check alive</label>
                <input type="checkbox" id="node-config-input-hbCheck" style="display: inline-block; width: auto; vertical-align: top">
            </div>
            <div class="form-row" id="check-heartbeat" hidden>
                <div class="form-row">
                    <label for="node-config-input-hbType" style="width: 125px; padding-left: 10px;"> Type</label>
                    <select id="node-config-input-hbType"  style="width: calc(100% - 185px)">
                        <option value="ttl">Heartbeat</option>
                        <option value="lwt" selected>Last Will</option>
                    </select>
                </div>
                <div class="form-row" id="heartbeat-ttl">
                    <div class="form-row">
                        <label for="node-config-input-hbTTL" style="width: 125px; padding-left: 10px;"><i class="fa fa-heartbeat"></i> Warn after (seconds)</label>
                        <input type="number" id="node-config-input-hbTTL" style="width: calc(100% - 185px)" min="1" value="86400">
                    </div>                    
                </div>
                <div class="form-row" id="heartbeat-lwt" hidden>
                    <div class="form-row">
                        <label for="node-config-input-hbFilterVal" style="width: 125px; padding-left: 10px;"><i class="fa fa-filter"></i> Topic filter</label>
                        <input type="text" id="node-config-input-hbFilterVal" style="width: calc(100% - 185px)">
                        <input type="hidden" id="node-config-input-hbFilterType">
                    </div>
                    <div class="form-row">
                        <label for="node-config-input-hbLWT" style="width: 125px; padding-left: 10px;"><i class="fa fa-sign-in"></i> Ingress</label>
                        <select id="node-config-input-hbLWT" style="width: calc(100% - 185px)"></select>
                        <div class="form-tips" id="LWTNote"  style="margin-top: 10px; margin-left: 140px; width: calc(100% - 195px);"><b>Note:</b> Ingress function should return true or false.</div>
                    </div>   
                </div>
            </div>
            <div class="form-row">
                <ol id="node-config-thingtype-list-attributes"></ol>
            </div>
            <div class="form-row">
                <ol id="node-config-thingtype-list-items"></ol>
            </div>
        </div>
        <!-- Ingress tab -->
        <div id="tab-ingress" style="display:none">
            <div class="form-row">
                <ol id="node-config-ingress-list-items"></ol>
            </div>
            <div class="form-row">
                <button id="tab-ingress-copy-show"><i class="fa fa-copy"></i></button>
            </div>
            <div class="form-row" id="tab-ingress-copy" hidden>
                <div class="form-row">
                    <label for="tab-ingress-copy-thing"><i class="fa fa-gears"></i> Type</label>
                    <select id="tab-ingress-copy-thing" style="width:70%"></select>
                </div>
                <div class="form-row">
                    <label for="tab-ingress-copy-ingress"><i class="fa fa-sign-in"></i> Function</label>
                    <select id="tab-ingress-copy-ingress" style="width:70%"></select>
                </div>
                <div class="form-row">
                    <button id="tab-ingress-copy-button"><i class="fa fa-copy"></i> Import function</button>
                </div>
            </div>
        </div>
        <!-- Egress tab -->
        <div id="tab-egress" style="display:none">
            <div class="form-row">
                <ol id="node-config-egress-list-items"></ol>
            </div>
            <div class="form-row">
                <button id="tab-egress-copy-show"><i class="fa fa-copy"></i></button>
            </div>
            <div class="form-row" id="tab-egress-copy" hidden>
                <div class="form-row">
                    <label for="tab-egress-copy-thing"><i class="fa fa-gears"></i> Type</label>
                    <select id="tab-egress-copy-thing" style="width:70%"></select>
                </div>
                <div class="form-row">
                    <label for="tab-egress-copy-egress"><i class="fa fa-sign-out"></i> Function</label>
                    <select id="tab-egress-copy-egress" style="width:70%"></select>
                </div>
                <div class="form-row">
                    <button id="tab-egress-copy-button"><i class="fa fa-copy"></i> Import function</button>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="hal2ThingType">
    <p>The Thing <i>type</i> defines the functions of the device as a list of <i>items</i> where each item corresponds to a specific measurement or command. For example: a <i>sensor</i> Thing Type might have a temperature-item and a humidity-item. A <i>switch</i> Thing Type might have a relay0 and a relay1 item. It can be queried by the <i>Value</i>, <i>Gate</i> and <i>Action</i> nodes and can trigger an event using <i>Event</i> nodes.</p>
    <li><strong>Name</strong>: A describing name for the specific device type. For example, 'Shelly Dimmer'.</li>
    <li><strong>Context store</strong>: The Node-RED context store used to store device values. Please see <a href="https://nodered.org/docs/user-guide/context" target="_blank">Node-RED documentation</a> for more information about different types of context stores. Use file-based storage for persistent context.</li>
    <li><strong>Show state</strong>: A string defining how to show information about state on the node in the Node-RED GUI. Use <code>%Item_name%</code> (case sensitive) to show a specific item value. Leave blank if not wanted.</li>
    <li><strong>Check alive</strong>: Check if device is alive, either by checking for heartbeats or by using MQTT Last Will and Testament information. If checked a specific <i>Alive</i> Item is automatically create. Possible values: true/false.</li>    
    <li><strong>Items</strong>: Define items. See example code on <a href="https://github.com/flic/node-red-contrib-hal2/tree/main/examples" target="_blank">GitHub</a>.</li>    
</script>
